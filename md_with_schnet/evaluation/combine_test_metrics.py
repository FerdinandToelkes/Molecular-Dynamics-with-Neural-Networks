import os
import argparse
import pandas as pd

from md_with_schnet.setup_logger import setup_logger


# Example command to run the script from within code directory:
"""
python -m md_with_schnet.evaluation.combine_test_metrics -mdir epochs_1000_bs_100_lr_0.0001_seed_42 
"""


logger = setup_logger("debug")

def parse_args() -> dict:
    """ 
    Parse command-line arguments. 

    Returns:
        dict: Dictionary containing command-line arguments.
    """
    parser = argparse.ArgumentParser(description="Script for predicting with trained model on XTB test data.")
    # paths setup
    parser.add_argument("--trajectory_dir", type=str, default="MOTOR_MD_XTB/T300_1", help="Directory containing the trajectory data generated by Turbomole (default: MOTOR_MD_XTB/T300_1)")
    parser.add_argument("-mdir", "--model_dir", type=str, default="epochs_1000_bs_100_lr_0.0001_seed_42", help="Directory of the trained model (default: epochs_1000_bs_100_lr_0.0001_seed_42)")
    parser.add_argument("-f", "--fold", type=int, default=0, help="Fold number for cross-validation (default: 0)")
    return vars(parser.parse_args())

def main(trajectory_dir: str, model_dir: str, fold: int) -> None:
    home_dir = os.path.expanduser("~")
    path_to_runs = os.path.join(home_dir, "whk/code/md_with_schnet/training_and_inference/runs")
    unit_systems = ["angstrom_kcal_per_mol_fs", "angstrom_ev_fs", "angstrom_hartree_fs"]
    logger.info(f"Unit systems to be examined: {unit_systems}")
    results = {}
    
    for units in unit_systems:
        target_dir = os.path.join(path_to_runs, units, trajectory_dir, model_dir)
        logger.info(f"Processing directory: {target_dir}")
        
        # Check if the directory exists
        if not os.path.exists(target_dir):
            logger.warning(f"Directory {target_dir} does not exist. Skipping.")
            continue
        
        # Load the metrics file
        metrics_file = os.path.join(target_dir, f"test_metrics_fold_{fold}.csv")
        if not os.path.isfile(metrics_file):
            logger.warning(f"Metrics file {metrics_file} does not exist. Skipping.")
            continue
        
        df = pd.read_csv(metrics_file)
        # only take values for kcal and kcal/mol
        results[units] = {
            "energy_mae_kcal_per_mol": df["energy_mae_kcal_per_mol"],
            "energy_mae_std_err_kcal_per_mol": df["energy_mae_std_err_kcal_per_mol"],
            "forces_mae_kcal_per_mol_per_angstrom": df["forces_mae_kcal_per_mol_per_angstrom"],
            "forces_mae_std_err_kcal_per_mol_per_angstrom": df["forces_mae_std_err_kcal_per_mol_per_angstrom"] 
        }
    # Combine results into a single DataFrame with the units as columns and the two metrics as rows
    combined_results = pd.DataFrame({
        "units_trained_on": unit_systems,
        "energy_mae_kcal_per_mol": [results[units]["energy_mae_kcal_per_mol"].mean() for units in unit_systems],
        "energy_mae_std_err_kcal_per_mol": [results[units]["energy_mae_std_err_kcal_per_mol"].mean() for units in unit_systems],
        "forces_mae_kcal_per_mol_per_angstrom": [results[units]["forces_mae_kcal_per_mol_per_angstrom"].mean() for units in unit_systems],
        "forces_mae_std_err_kcal_per_mol_per_angstrom": [results[units]["forces_mae_std_err_kcal_per_mol_per_angstrom"].mean() for units in unit_systems]
    })
    # transpose the DataFrame to have metrics as rows and units as columns
    combined_results = combined_results.set_index("units_trained_on").T
    logger.info(f"Combined test metrics:\n{combined_results}")
    
    # Save the combined results to a CSV file
    trajectory_dir = trajectory_dir.replace("/", "_")
    save_name = f"test_metrics_{trajectory_dir}_{model_dir}_fold_{fold}"
    output_file = os.path.join(path_to_runs, f"{save_name}.csv")
    combined_results.to_csv(output_file)
    logger.info(f"Combined test metrics saved to {output_file}")

    # Convert csv to LaTeX table format
    latex_table = combined_results.to_latex(float_format="%.6f", column_format="lcccc", header=True, index=True)
    latex_table = latex_table.replace("\\begin{tabular}{lcccc}", "\\begin{tabular}{lcccc} \\toprule")
    latex_table = latex_table.replace("\\end{tabular}", "\\bottomrule \n\\end{tabular}")
    latex_output_file = os.path.join(path_to_runs, f"{save_name}.tex")
    with open(latex_output_file, "w") as f:
        f.write(latex_table)
    logger.info(f"Combined test metrics saved to {latex_output_file} in LaTeX format")


if __name__ == "__main__":
    args = parse_args()
    main(**args)

